<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMHUB | <%= product.model %>
    </title>
    <link rel="icon" type="image/x-icon" href="/images/NavImg.jpg">

    <!-- Bootstrap 4.5.2 -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <style>
        :root {
            --rm-primary: #3cf696;
            --rm-primary-2: #22d67f;
            --rm-ink: #0f172a;
            --rm-muted: rgba(15, 23, 42, 0.65);
            --rm-border: rgba(15, 23, 42, 0.10);
            --rm-shadow: 0 18px 40px rgba(2, 6, 23, 0.12);
            --rm-radius: 18px;
            --rm-radius-lg: 22px;
        }

        body {
            font-family: Arial, sans-serif;
            color: var(--rm-ink);
            background:
                radial-gradient(1100px 600px at 15% 10%, rgba(60, 246, 150, 0.22), transparent 55%),
                radial-gradient(900px 500px at 90% 25%, rgba(60, 246, 150, 0.14), transparent 55%),
                #f8f9fa;
        }

        .page-wrap {
            margin-top: 18px;
            margin-bottom: 44px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.86);
            border: 1px solid rgba(255, 255, 255, 0.60);
            border-radius: var(--rm-radius-lg);
            box-shadow: var(--rm-shadow);
            overflow: hidden;
        }

        .section-pad {
            padding: 18px;
        }

        /* Gallery */
        .gallery-top {
            position: relative;
            padding: 18px;
            background: rgba(255, 255, 255, 0.75);
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        }

        .ribbon {
            position: absolute;
            top: 14px;
            left: 14px;
            background: linear-gradient(135deg, var(--rm-primary), var(--rm-primary-2));
            color: rgba(15, 23, 42, 0.95);
            font-size: 12px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 999px;
            box-shadow: 0 12px 18px rgba(2, 6, 23, 0.10);
            border: 1px solid rgba(255, 255, 255, 0.55);
            z-index: 2;
        }

        .img-stage {
            width: 100%;
            height: 420px;
            border-radius: 18px;
            background: #ffffff;
            border: 1px solid rgba(15, 23, 42, 0.10);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* KEY: full image visible */
        .img-stage img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 12px;
            display: block;
            transition: transform 180ms ease, filter 180ms ease;
        }

        .img-stage:hover img {
            transform: scale(1.03);
            filter: saturate(1.02);
        }

        .thumbs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 14px 18px 18px 18px;
            background: rgba(255, 255, 255, 0.75);
        }

        .thumb {
            width: 74px;
            height: 74px;
            border-radius: 14px;
            background: #fff;
            border: 1px solid rgba(15, 23, 42, 0.10);
            box-shadow: 0 10px 16px rgba(2, 6, 23, 0.06);
            overflow: hidden;
            cursor: pointer;
            transition: transform 160ms ease, border-color 160ms ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thumb:hover {
            transform: translateY(-2px);
            border-color: rgba(34, 214, 127, 0.55);
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 8px;
            display: block;
        }

        /* Content */
        .title-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .product-title {
            margin: 0;
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(60, 246, 150, 0.18);
            border: 1px solid rgba(60, 246, 150, 0.30);
            font-weight: 900;
            color: rgba(15, 23, 42, 0.92);
            white-space: nowrap;
            box-shadow: 0 10px 16px rgba(2, 6, 23, 0.06);
        }

        .muted {
            color: var(--rm-muted);
            font-weight: 700;
        }

        .rating-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .rating-badge {
            background: rgba(15, 23, 42, 0.10);
            border: 1px solid rgba(15, 23, 42, 0.12);
            border-radius: 999px;
            padding: 6px 10px;
            font-weight: 900;
        }

        .fas.fa-star.filled {
            color: gold;
        }

        .far.fa-star {
            color: rgba(15, 23, 42, 0.65);
        }

        .btn-rm {
            border: none;
            border-radius: 14px;
            font-weight: 900;
            padding: 10px 14px;
            color: rgba(15, 23, 42, 0.95);
            background: linear-gradient(135deg, var(--rm-primary), var(--rm-primary-2));
            box-shadow: 0 18px 30px rgba(34, 214, 127, 0.18);
            transition: transform 160ms ease, filter 160ms ease;
        }

        .btn-rm:hover {
            transform: translateY(-1px);
            filter: brightness(0.98);
            color: rgba(15, 23, 42, 0.95);
        }

        .btn-soft {
            border: 1px solid rgba(15, 23, 42, 0.12);
            background: rgba(255, 255, 255, 0.70);
            border-radius: 14px;
            font-weight: 900;
            padding: 10px 14px;
            color: rgba(15, 23, 42, 0.92);
            transition: transform 160ms ease, background 160ms ease;
        }

        .btn-soft:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.85);
            color: rgba(15, 23, 42, 0.95);
        }

        .price-box {
            margin-top: 14px;
            padding: 14px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.70);
            border: 1px solid rgba(15, 23, 42, 0.10);
        }

        .price-now {
            font-weight: 900;
            font-size: 22px;
            margin: 0;
        }

        .price-old {
            margin: 4px 0 0 0;
            font-weight: 800;
            color: rgba(15, 23, 42, 0.55);
            text-decoration: line-through;
            font-size: 14px;
        }

        .about-box {
            margin-top: 14px;
            padding: 14px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.70);
            border: 1px solid rgba(15, 23, 42, 0.10);
        }

        .about-box h6 {
            margin: 0 0 8px 0;
            font-weight: 900;
        }

        .spec-grid {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .spec {
            border-radius: 14px;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.05);
            border: 1px solid rgba(15, 23, 42, 0.08);
            font-weight: 800;
            color: rgba(15, 23, 42, 0.92);
        }

        .spec small {
            display: block;
            font-weight: 800;
            color: rgba(15, 23, 42, 0.60);
            margin-bottom: 2px;
        }

        .purchase-row {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .qty {
            width: 110px;
            height: 44px;
            border-radius: 14px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            background: rgba(255, 255, 255, 0.75);
            font-weight: 900;
            text-align: center;
        }

        @media (max-width: 991.98px) {
            .img-stage {
                height: 340px;
            }

            .spec-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <%- include("nav") %>

        <div class="container page-wrap">
            <div class="row">

                <!-- LEFT: GALLERY -->
                <div class="col-lg-6 mb-3">
                    <div class="glass-card">

                        <div class="gallery-top">
                            <% if (product.onOffer) { %>
                                <div class="ribbon">
                                    <%= product.discount %>% OFF
                                </div>
                                <% } %>

                                    <div class="img-stage">
                                        <img id="mainImage" src="<%= product.image[0].replace(/\\/g, '/') %>"
                                            data-zoom-image="<%= product.image[0].replace(/\\/g, '/') %>"
                                            alt="<%= product.model %>">
                                    </div>
                        </div>

                        <div class="thumbs">
                            <div class="thumb" onclick="changeImage('<%= product.image[0].replace(/\\/g, '/') %>')">
                                <img src="<%= product.image[0].replace(/\\/g, '/') %>" alt="Thumb 1">
                            </div>

                            <% if (product.image[1]) { %>
                                <div class="thumb" onclick="changeImage('<%= product.image[1].replace(/\\/g, '/') %>')">
                                    <img src="<%= product.image[1].replace(/\\/g, '/') %>" alt="Thumb 2">
                                </div>
                                <% } %>

                                    <% if (product.image[2]) { %>
                                        <div class="thumb"
                                            onclick="changeImage('<%= product.image[2].replace(/\\/g, '/') %>')">
                                            <img src="<%= product.image[2].replace(/\\/g, '/') %>" alt="Thumb 3">
                                        </div>
                                        <% } %>

                                            <% if (product.image[3]) { %>
                                                <div class="thumb"
                                                    onclick="changeImage('<%= product.image[3].replace(/\\/g, '/') %>')">
                                                    <img src="<%= product.image[3].replace(/\\/g, '/') %>"
                                                        alt="Thumb 4">
                                                </div>
                                                <% } %>
                        </div>

                    </div>
                </div>

                <!-- RIGHT: CONTENT -->
                <div class="col-lg-6 mb-3">
                    <div class="glass-card section-pad">

                        <div class="title-row">
                            <div>
                                <h1 class="product-title">
                                    <%= product.model %>
                                </h1>
                                <div class="muted mt-1">
                                    <%= product.color %>
                                        <% if (product.category && product.category.name) { %>
                                            • <%= product.category.name %>
                                                <% } %>
                                </div>
                            </div>

                            <div class="chip">
                                <i class="fas fa-box"></i>
                                <span>
                                    <%= product.availableStock %> in stock
                                </span>
                            </div>
                        </div>

                        <div class="rating-row">
                            <span class="rating-badge"><i class="fas fa-star mr-1"></i>
                                <%= product.ratings %>
                            </span>

                            <span>
                                <% for (let i=1; i <=5; i++) { %>
                                    <% if (i <=product.ratings) { %>
                                        <i class="fas fa-star filled"></i>
                                        <% } else { %>
                                            <i class="far fa-star"></i>
                                            <% } %>
                                                <% } %>
                            </span>

                            <button type="button" class="btn btn-soft" id="seeReviewsBtn" data-toggle="modal"
                                data-target="#reviewsModal">
                                <i class="far fa-comment-dots mr-2"></i>View reviews
                            </button>
                        </div>

                        <div class="price-box">
                            <p class="price-now">
                                <% if (product.onOffer) { %>
                                    ₹<%= Number(product.offerPrice).toLocaleString('en-IN') %>
                                        <% } else { %>
                                            ₹<%= Number(product.price).toLocaleString('en-IN') %>
                                                <% } %>
                            </p>

                            <% if (product.onOffer) { %>
                                <p class="price-old">₹<%= Number(product.price).toLocaleString('en-IN') %>
                                </p>
                                <% } %>

                                    <div class="muted" style="font-weight:800;">
                                        <i class="fas fa-shipping-fast mr-2"></i>Delivery available (as per your service
                                        zones)
                                    </div>
                        </div>

                        <div class="about-box">
                            <h6>About this item</h6>
                            <div class="muted" style="text-align:left;">
                                <%= product.description %>
                            </div>

                            <div class="spec-grid">
                                <div class="spec"><small>Color</small>
                                    <%= product.color %>
                                </div>
                                <div class="spec"><small>Stock</small>
                                    <%= product.availableStock %>
                                </div>
                                <div class="spec"><small>Category</small>
                                    <%= product.category?.name %>
                                </div>
                                <div class="spec"><small>Shipping</small>All over the world</div>
                            </div>
                        </div>

                        <div class="purchase-row">
                            <form action="/cart/addtocart" method="post" onsubmit="return validateQuantity()"
                                class="d-flex align-items-center" style="gap:10px; flex-wrap:wrap;">
                                <input type="hidden" name="productId" value="<%= product._id %>">
                                <input type="number" name="quantity" id="quantity" value="1" min="1" class="qty">
                                <button type="submit" class="btn-rm">
                                    Add to Cart <i class="fas fa-shopping-cart ml-2"></i>
                                </button>
                            </form>

                            <button type="button" class="btn btn-soft" id="rateButton">
                                <i class="fas fa-star mr-2"></i>Rate this product
                            </button>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <!-- Reviews Modal -->
        <div class="modal fade" id="reviewsModal" tabindex="-1" role="dialog" aria-labelledby="reviewsModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content"
                    style="border-radius:18px; overflow:hidden; border:none; box-shadow: var(--rm-shadow);">
                    <div class="modal-header"
                        style="background:linear-gradient(135deg,#3cf696,#22d67f); border-bottom:none;">
                        <h5 class="modal-title" id="reviewsModalLabel" style="font-weight:900; margin:0;">Product
                            Reviews</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="opacity:1;">
                            <span aria-hidden="true" style="font-weight:900;">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <ol id="reviews-list" class="list-unstyled mb-0"></ol>
                        <div id="reviews-empty" class="muted" style="display:none; font-weight:800;">No reviews yet.
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top:1px solid rgba(15,23,42,0.08);">
                        <button type="button" class="btn btn-soft" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <%- include("footer") %>

            <!-- Rating Modal -->
            <%- include("ratingmodal", { productId: productId }) %>

                <!-- Scripts -->
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script
                    src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/3.0.8/jquery.elevatezoom.min.js"></script>
                <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

                <script>
                    // Zoom init (safe re-init)
                    function initZoom() {
                        const $img = $('#mainImage');

                        // hard cleanup (important for swapping)
                        try {
                            const ez = $img.data('elevateZoom');
                            if (ez && typeof ez.destroy === 'function') ez.destroy();
                        } catch (e) { }

                        try { $('.zoomContainer').remove(); } catch (e) { }

                        // IMPORTANT: clear cached data keys used by elevateZoom/jQuery
                        $img.removeData('elevateZoom');
                        $img.removeData('zoomImage');     // this is the usual cached key
                        $img.removeData('zoom-image');    // safety
                        $img.off('.elevateZoom');         // safety

                        // re-init
                        $img.elevateZoom({
                            zoomType: "lens",
                            lensShape: "round",
                            lensSize: 170,
                            scrollZoom: true,
                            responsive: true,
                            containLensZoom: true
                        });
                    }


                    $(document).ready(function () {
                        initZoom();

                        $('#copyLink').on('click', async function (e) {
                            e.preventDefault();
                            try {
                                await navigator.clipboard.writeText(url);
                                Swal.fire({ icon: 'success', title: 'Copied', text: 'Link copied to clipboard.' });
                            } catch (err) {
                                Swal.fire({ icon: 'error', title: 'Copy failed', text: 'Could not copy link.' });
                            }
                        });
                    });

                    function changeImage(imageUrl) {
                        const $img = $('#mainImage');

                        // Always update DOM attributes
                        $img.attr('src', imageUrl);
                        $img.attr('data-zoom-image', imageUrl);

                        // Best path: swap without reinitializing (prevents zoom using first image)
                        const ez = $img.data('elevateZoom');
                        if (ez && typeof ez.swaptheimage === 'function') {
                            ez.swaptheimage(imageUrl, imageUrl); // (small, large)
                            return;
                        }

                        // Fallback: re-init zoom if plugin not ready yet
                        initZoom();
                    }
                    $(document).ready(function () {
                        initZoom();
                    });

                    // Load reviews when modal opens (single source of truth)
                    $('#reviewsModal').on('show.bs.modal', function () {
                        const productId = '<%= product._id %>';

                        $.ajax({
                            url: '/reviews/' + productId,
                            type: 'GET',
                            success: function (response) {
                                const reviews = (response && response.reviews) ? response.reviews : [];
                                const reviewsList = document.getElementById('reviews-list');
                                const emptyEl = document.getElementById('reviews-empty');

                                reviewsList.innerHTML = '';

                                if (!reviews.length) {
                                    emptyEl.style.display = 'block';
                                    return;
                                }

                                emptyEl.style.display = 'none';

                                reviews.forEach(function (review) {
                                    const li = document.createElement('li');
                                    li.style.padding = '10px 12px';
                                    li.style.borderRadius = '14px';
                                    li.style.border = '1px solid rgba(15,23,42,0.10)';
                                    li.style.background = 'rgba(255,255,255,0.70)';
                                    li.style.marginBottom = '10px';
                                    li.style.fontWeight = '800';
                                    li.style.color = 'rgba(15,23,42,0.85)';
                                    li.textContent = review;
                                    reviewsList.appendChild(li);
                                });
                            },
                            error: function (error) {
                                console.error('Error fetching reviews:', error);
                            }
                        });
                    });

                    // Rate button -> open rating modal and bind productId into modal form
                    document.getElementById('rateButton').addEventListener('click', function () {
                        const productId = document.querySelector('input[name="productId"]').value;
                        document.querySelector('#ratingReviewForm input[name="productId"]').value = productId;
                        $('#ratingReviewModal').modal('show');
                    });

                    // Quantity validation (SweetAlert)
                    function validateQuantity() {
                        const quantity = parseInt(document.getElementById('quantity').value);
                        const availableStock = parseInt('<%= product.availableStock %>');

                        if (isNaN(quantity) || quantity <= 0) {
                            Swal.fire({ icon: 'error', title: 'Oops...', text: 'Please enter a valid quantity!' });
                            return false;
                        }

                        if (quantity > availableStock) {
                            Swal.fire({ icon: 'error', title: 'Oops...', text: 'Quantity exceeds available stock!' });
                            return false;
                        }

                        return true;
                    }
                </script>
</body>

</html>