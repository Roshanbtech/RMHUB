<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RMHUB</title>
  <link rel="icon" type="image/x-icon" href="/images/NavImg.jpg">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  <!-- Cropper -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.1.2/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    body { background-color: #f8f9fa; font-family: Arial, sans-serif; }

    .container { max-width: 600px; margin: 30px auto; }

    .form-container {
      width: 100%;
      padding: 20px;
      background-color: #fff;
      border-radius: 20px;
      box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.1);
      animation: slideIn 1s ease;
      margin: 0 auto;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .btn-success {
      background-color: #3cf696;
      border-color: #3cf696;
      color: #fff;
      font-weight: bold;
      transition: all 0.3s ease;
      display: inline-block;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
    }

    .btn-success:hover { background-color: #36e687; border-color: #36e687; }

    .product-title {
      background-color: #3cf696;
      color: #fff;
      padding: 15px;
      border-radius: 20px;
      margin-bottom: 30px;
      font-size: 28px;
      text-align: center;
    }

    .form-group { margin-bottom: 15px; }

    .form-control {
      border-radius: 10px;
      border: 1px solid #3CF696;
      padding: 10px;
      width: 100%;
      background-color: #ffffff;
    }

    /* Bootstrap custom-file tweaks (Bootstrap 4) */
    .custom-file-label {
      border-radius: 10px;
      border: 1px solid #3CF696;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .custom-file-input:focus ~ .custom-file-label {
      border-color: #3CF696;
      box-shadow: 0 0 0 0.2rem rgba(60, 246, 150, 0.25);
    }

    .image-container { display: flex; flex-wrap: wrap; gap: 10px; }

    .preview-image-wrapper {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 8px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .preview-image {
      width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #ddd;
      cursor: default;
    }

    .preview-actions { display: flex; gap: 8px; width: 100%; justify-content: center; }

    .mini-btn {
      border: none;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .mini-btn.crop { background: #3cf696; color: #000; font-weight: 700; }
    .mini-btn.remove { background: #e74c3c; }

    .error { font-size: 13px; margin-top: 5px; }

    /* Cropper modal */
    #cropperModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.55);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .cropper-container {
      width: min(95vw, 820px);
      max-height: 90vh;
      background: #fff;
      border-radius: 16px;
      border: 2px solid #3cf696;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .cropper-header {
      padding: 12px 14px;
      background: #3cf696;
      color: #000;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cropper-body {
      padding: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
    }

    #cropperImage {
      max-width: 100%;
      max-height: 65vh;
      display: block;
    }

    .cropper-footer {
      padding: 12px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .btn-crop {
      background: #3cf696;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 800;
      cursor: pointer;
      color: #000;
    }

    .btn-cancel {
      background: #e5e5e5;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 800;
      cursor: pointer;
    }

    .file-meta {
      display: block;
      margin-top: 8px;
      color: #6c757d;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <%- include("sidebar") %>

  <div class="container">
    <div class="form-container">
      <h2 class="product-title">Edit Product</h2>

      <form action="/admin/editproducts/<%= product.id %>" method="post" enctype="multipart/form-data"
        onsubmit="return validateForm()">

        <div class="form-group">
          <input type="text" class="form-control" placeholder="Product Name" name="productName"
            value="<%= product.productName %>" id="productName">
          <div id="productNameError" class="error"></div>
        </div>

        <div class="form-group">
          <input type="number" class="form-control" placeholder="Price" name="price" value="<%= product.price %>"
            id="price">
          <div id="priceError" class="error"></div>
        </div>

        <div class="form-group">
          <input type="text" class="form-control" placeholder="Model" name="model" value="<%= product.model %>"
            id="model">
          <div id="modelError" class="error"></div>
        </div>

        <div class="form-group">
          <textarea class="form-control" placeholder="Description" name="description"
            id="description"><%= product.description %></textarea>
          <div id="descriptionError" class="error"></div>
        </div>

        <div class="form-group">
          <input type="number" class="form-control" placeholder="Available Stock" name="availableStock"
            value="<%= product.availableStock %>" id="availableStock">
          <div id="availableStockError" class="error"></div>
        </div>

        <!-- File input (Bootstrap custom-file) -->
        <div class="form-group">
          <div class="custom-file">
            <input type="file" class="custom-file-input" name="image" id="image" multiple accept="image/*">
            <label class="custom-file-label" for="image" id="fileInputLabel">Choose files</label>
          </div>

          <div id="imageError" class="error"></div>
          <small id="fileCountLabel" class="file-meta"></small>

          <br>

          <!-- EXISTING images -->
          <div class="image-container" id="existingPreview">
            <% if (product.image && product.image.length) { %>
              <% product.image.forEach((img)=> { %>
                <div class="preview-image-wrapper" data-existing="true">
                  <img src="<%= img %>" class="preview-image" alt="existing-image">
                  <input type="hidden" name="existingImages" value="<%= img %>">

                  <div class="preview-actions">
                    <button type="button" class="mini-btn crop" onclick="cropExistingImage(this)">
                      <i class="fas fa-crop"></i> Crop
                    </button>
                    <button type="button" class="mini-btn remove" onclick="removeExistingImage(this)">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>

          <!-- NEW images -->
          <div class="image-container mt-2" id="newPreview"></div>
        </div>

        <div class="form-group">
          <input type="text" class="form-control" placeholder="Color" name="color" value="<%= product.color %>"
            id="color">
          <div id="colorError" class="error"></div>
        </div>

        <div class="form-group">
          <select class="form-control" name="category" required style="background-color:#d8f0dd" id="category">
            <option value="" disabled>Select Category</option>
            <% categories.forEach(category=> { %>
              <% if (product.category && product.category.toString()===category._id.toString()) { %>
                <option value="<%= category._id %>" selected><%= category.name %></option>
              <% } else { %>
                <option value="<%= category._id %>"><%= category.name %></option>
              <% } %>
            <% }) %>
          </select>
          <div id="categoryError" class="error"></div>
        </div>

        <button type="submit" class="btn btn-success">Save</button>
      </form>
    </div>
  </div>

  <!-- Cropper Modal -->
  <div id="cropperModal">
    <div class="cropper-container">
      <div class="cropper-header">
        <span>Crop Image</span>
        <button type="button" class="btn-cancel" id="closeCropX">X</button>
      </div>
      <div class="cropper-body">
        <img id="cropperImage" src="" alt="Cropper">
      </div>
      <div class="cropper-footer">
        <button type="button" class="btn-cancel" id="cancelCropButton">Cancel</button>
        <button type="button" class="btn-crop" id="cropButton">Crop & Apply</button>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const imageInput = document.getElementById('image');
    const fileInputLabel = document.getElementById('fileInputLabel');
    const fileCountLabel = document.getElementById('fileCountLabel');
    const newPreview = document.getElementById('newPreview');

    // New files state
    let newFiles = [];

    // Cropper state
    const cropperModal = document.getElementById('cropperModal');
    const cropperImage = document.getElementById('cropperImage');
    const cropButton = document.getElementById('cropButton');
    const cancelCropButton = document.getElementById('cancelCropButton');
    const closeCropX = document.getElementById('closeCropX');

    let cropper = null;
    let cropMode = null; // "new" | "existing"
    let croppingIndex = null; // for new
    let croppingExistingWrapper = null; // for existing
    let tempObjectURL = null;

    function getExistingCount() {
      return document.querySelectorAll('input[name="existingImages"]').length;
    }

    function updateFileLabels() {
      const existingCount = getExistingCount();
      const newCount = newFiles.length;
      const total = existingCount + newCount;

      // Bootstrap custom-file label (avoid "No file chosen" UX)
      if (fileInputLabel) {
        fileInputLabel.textContent = newCount > 0 ? `${newCount} file(s) selected` : 'Choose files';
      }

      // Secondary KPI label (very clear to users)
      if (fileCountLabel) {
        fileCountLabel.textContent = `New uploads: ${newCount} | Existing kept: ${existingCount} | Total images: ${total}`;
      }
    }

    function syncInputFiles() {
      const dt = new DataTransfer();
      newFiles.forEach(f => dt.items.add(f));
      imageInput.files = dt.files;
      updateFileLabels();
    }

    function renderNewPreviews() {
      newPreview.innerHTML = '';

      newFiles.forEach((file, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'preview-image-wrapper';

        const img = document.createElement('img');
        img.className = 'preview-image';
        img.alt = file.name;

        const url = URL.createObjectURL(file);
        img.src = url;
        img.onload = () => URL.revokeObjectURL(url);

        const actions = document.createElement('div');
        actions.className = 'preview-actions';

        const cropBtn = document.createElement('button');
        cropBtn.type = 'button';
        cropBtn.className = 'mini-btn crop';
        cropBtn.innerHTML = '<i class="fas fa-crop"></i> Crop';
        cropBtn.onclick = () => openCropperForNew(index);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'mini-btn remove';
        removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
        removeBtn.onclick = () => removeNewFile(index);

        actions.appendChild(cropBtn);
        actions.appendChild(removeBtn);

        wrapper.appendChild(img);
        wrapper.appendChild(actions);
        newPreview.appendChild(wrapper);
      });

      updateFileLabels();
    }

    function removeNewFile(index) {
      newFiles.splice(index, 1);
      syncInputFiles();
      renderNewPreviews();
    }

    // Existing image removal
    function removeExistingImage(btn) {
      const wrapper = btn.closest('.preview-image-wrapper');
      if (!wrapper) return;

      const hidden = wrapper.querySelector('input[name="existingImages"]');
      if (hidden) hidden.remove();

      wrapper.remove();
      updateFileLabels();
    }

    // NEW file selection: append
    imageInput.addEventListener('change', function () {
      const picked = Array.from(this.files || []);
      if (picked.length === 0) return;

      for (const f of picked) {
        if (!f.type || !f.type.startsWith('image/')) {
          Swal.fire({
            icon: 'error',
            title: 'Invalid file',
            text: 'Only image files are allowed.',
            toast: true,
            position: 'top-end',
            confirmButtonColor: '#3cf696',
            confirmButtonText: 'OK',
            showConfirmButton: true,
          });
          continue;
        }

        // Avoid duplicates (name+size+lastModified)
        const exists = newFiles.some(x =>
          x.name === f.name && x.size === f.size && x.lastModified === f.lastModified
        );
        if (!exists) newFiles.push(f);
      }

      syncInputFiles();
      renderNewPreviews();

      // Allow selecting same file again later
      this.value = '';
      updateFileLabels();
    });

    // -------- Cropper plumbing --------

    function openCropperWithFile(file, mode, indexOrWrapper) {
      cropMode = mode;

      if (mode === 'new') {
        croppingIndex = indexOrWrapper;
        croppingExistingWrapper = null;
      } else {
        croppingExistingWrapper = indexOrWrapper;
        croppingIndex = null;
      }

      if (cropper) {
        cropper.destroy();
        cropper = null;
      }

      if (tempObjectURL) {
        URL.revokeObjectURL(tempObjectURL);
        tempObjectURL = null;
      }

      tempObjectURL = URL.createObjectURL(file);
      cropperImage.src = tempObjectURL;

      cropperImage.onload = () => {
        cropper = new Cropper(cropperImage, {
          viewMode: 2,
          autoCropArea: 1,
          responsive: true,
          background: false,
        });
      };

      cropperModal.style.display = 'flex';
    }

    function closeCropper() {
      cropperModal.style.display = 'none';

      if (cropper) {
        cropper.destroy();
        cropper = null;
      }

      if (tempObjectURL) {
        URL.revokeObjectURL(tempObjectURL);
        tempObjectURL = null;
      }

      cropMode = null;
      croppingIndex = null;
      croppingExistingWrapper = null;
      cropperImage.src = '';
    }

    function openCropperForNew(index) {
      const file = newFiles[index];
      openCropperWithFile(file, 'new', index);
    }

    // Crop EXISTING URL: fetch -> File -> crop -> remove existing -> add as new upload
    async function cropExistingImage(btn) {
      const wrapper = btn.closest('.preview-image-wrapper');
      if (!wrapper) return;

      const imgEl = wrapper.querySelector('img.preview-image');
      const url = imgEl ? imgEl.src : null;
      if (!url) return;

      try {
        const res = await fetch(url, { mode: 'cors' });
        if (!res.ok) throw new Error('Fetch failed');

        const blob = await res.blob();
        const mimeType = blob.type && blob.type.startsWith('image/') ? blob.type : 'image/jpeg';

        const file = new File([blob], `existing_${Date.now()}.jpg`, { type: mimeType, lastModified: Date.now() });
        openCropperWithFile(file, 'existing', wrapper);
      } catch (err) {
        Swal.fire({
          icon: 'warning',
          title: 'Cannot crop this existing image',
          text: 'Your image host may block cross-origin fetch. Remove it and re-upload the image to crop.',
          confirmButtonColor: '#3cf696',
          confirmButtonText: 'OK'
        });
      }
    }

    cropButton.addEventListener('click', function () {
      if (!cropper) return;

      const canvas = cropper.getCroppedCanvas({
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });

      canvas.toBlob((blob) => {
        if (!blob) return;

        const croppedFile = new File(
          [blob],
          `cropped_${Date.now()}.jpg`,
          { type: 'image/jpeg', lastModified: Date.now() }
        );

        if (cropMode === 'new' && croppingIndex !== null) {
          newFiles[croppingIndex] = croppedFile;
        }

        if (cropMode === 'existing' && croppingExistingWrapper) {
          // Remove existing hidden input + wrapper
          const hidden = croppingExistingWrapper.querySelector('input[name="existingImages"]');
          if (hidden) hidden.remove();
          croppingExistingWrapper.remove();

          // Add cropped to new uploads
          newFiles.push(croppedFile);
        }

        syncInputFiles();
        renderNewPreviews();
        closeCropper();
      }, 'image/jpeg', 0.9);
    });

    cancelCropButton.addEventListener('click', closeCropper);
    closeCropX.addEventListener('click', closeCropper);

    cropperModal.addEventListener('click', (e) => {
      if (e.target === cropperModal) closeCropper();
    });

    // -------- Validation --------
    function validateForm() {
      const productName = document.getElementById('productName').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const model = document.getElementById('model').value.trim();
      const description = document.getElementById('description').value.trim();
      const availableStock = parseFloat(document.getElementById('availableStock').value);
      const category = document.getElementById('category').value.trim();
      const color = document.getElementById('color').value.trim();

      const totalImages = getExistingCount() + newFiles.length;

      let isValid = true;

      if (productName === '') {
        document.getElementById('productNameError').innerHTML = '*Product Name is required';
        document.getElementById('productNameError').style.color = 'red';
        isValid = false;
      } else document.getElementById('productNameError').innerHTML = '';

      if (isNaN(price) || price <= 0) {
        document.getElementById('priceError').innerHTML = '*Price must be a positive number';
        document.getElementById('priceError').style.color = 'red';
        isValid = false;
      } else document.getElementById('priceError').innerHTML = '';

      if (model === '') {
        document.getElementById('modelError').innerHTML = '*Model is required';
        document.getElementById('modelError').style.color = 'red';
        isValid = false;
      } else document.getElementById('modelError').innerHTML = '';

      if (description === '') {
        document.getElementById('descriptionError').innerHTML = '*Description is required';
        document.getElementById('descriptionError').style.color = 'red';
        isValid = false;
      } else document.getElementById('descriptionError').innerHTML = '';

      if (isNaN(availableStock) || availableStock <= 0) {
        document.getElementById('availableStockError').innerHTML = '*Available Stock must be a positive number';
        document.getElementById('availableStockError').style.color = 'red';
        isValid = false;
      } else document.getElementById('availableStockError').innerHTML = '';

      if (category === '') {
        document.getElementById('categoryError').innerHTML = '*Category is required';
        document.getElementById('categoryError').style.color = 'red';
        isValid = false;
      } else document.getElementById('categoryError').innerHTML = '';

      if (totalImages === 0) {
        document.getElementById('imageError').innerHTML = '*At least one image is required';
        document.getElementById('imageError').style.color = 'red';
        isValid = false;
      } else document.getElementById('imageError').innerHTML = '';

      if (color === '') {
        document.getElementById('colorError').innerHTML = '*Color is required';
        document.getElementById('colorError').style.color = 'red';
        isValid = false;
      } else document.getElementById('colorError').innerHTML = '';

      // Ensure input.files matches our newFiles
      syncInputFiles();

      return isValid;
    }

    // Initial label state
    updateFileLabels();
  </script>

</body>
</html>
